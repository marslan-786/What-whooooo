version: '3.8'

services:
  # 1. ÚˆÛŒÙ¹Ø§ Ø¨ÛŒØ³ (Updated for AI/Vector Support)
  postgres:
    image: pgvector/pgvector:pg16
    restart: always
    environment:
      POSTGRES_DB: chatwoot
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password123
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5

  # 2. Ù…ÛŒÙ…ÙˆØ±ÛŒ/Ú©ÛŒØ´ (Redis)
  redis:
    image: redis:alpine
    restart: always
    command: ["sh", "-c", "redis-server --requirepass $REDIS_PASSWORD"]
    environment:
      REDIS_PASSWORD: password123
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "password123", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5

  # 3. Ù…ÛŒÙ† ÙˆÛŒØ¨ Ø³Ø±ÙˆØ± (Web App)
  web:
    image: chatwoot/chatwoot:latest
    restart: always
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    ports:
      - "3000:3000"
    environment:
      NODE_ENV: production
      RAILS_ENV: production
      INSTALLATION_ENV: docker
      # Database & Redis Connections
      DATABASE_URL: postgres://postgres:password123@postgres:5432/chatwoot
      REDIS_URL: redis://:password123@redis:6379
      # Storage
      ACTIVE_STORAGE_SERVICE: local
      # Logs
      RAILS_LOG_TO_STDOUT: true
      # ğŸ‘‡ ÛŒÛ Ú©ÛŒ Ù…ÛŒÚº Ù†Û’ ÛŒÛÛŒÚº ÚˆØ§Ù„ Ø¯ÛŒ ÛÛ’ ØªØ§Ú©Û Ø§ÛŒØ±Ø± Ù†Û Ø¢Ø¦Û’
      SECRET_KEY_BASE: "5f8d93b2a1c4e6f7g8h9i0j1k2l3m4n5o6p7q8r9s0t1u2v3w4x5y6z7a8b9c0d1e2f3g4h5i6j7k8l9m0n1o2p3q4r5s6t7u8v9w0x1y2z"
      # ğŸ‘‡ Ø¬Ø¨ Ø±ÛŒÙ„ÙˆÛ’ ÚˆÙˆÙ…ÛŒÙ† Ø¯Û’ØŒ ØªÙˆ ÛŒÛØ§Úº Ø¶Ø±ÙˆØ± ØªØ¨Ø¯ÛŒÙ„ Ú©Ø±ÛŒÚº
      FRONTEND_URL: "http://localhost:3000"
    volumes:
      - chatwoot_storage:/app/storage
    # ğŸ‘‡ Ø¢Ù¹Ùˆ Ø³ÛŒÙ¹ Ø§Ù¾ Ú©Ù…Ø§Ù†Úˆ (Ù¾ÛÙ„Û’ DB Ø¨Ù†Ø§Ø¦Û’ Ú¯ÛŒØŒ Ù¾Ú¾Ø± Ø³Ø±ÙˆØ± Ú†Ù„Ø§Ø¦Û’ Ú¯ÛŒ)
    command: >
      sh -c "bundle exec rails db:chatwoot_prepare; 
             bundle exec rails s -p 3000 -b 0.0.0.0"

  # 4. Ø¨ÛŒÚ© Ú¯Ø±Ø§Ø¤Ù†Úˆ ÙˆØ±Ú©Ø± (Worker)
  worker:
    image: chatwoot/chatwoot:latest
    restart: always
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      NODE_ENV: production
      RAILS_ENV: production
      INSTALLATION_ENV: docker
      DATABASE_URL: postgres://postgres:password123@postgres:5432/chatwoot
      REDIS_URL: redis://:password123@redis:6379
      ACTIVE_STORAGE_SERVICE: local
      # ğŸ‘‡ ÙˆØ±Ú©Ø± Ú©Ùˆ Ø¨Ú¾ÛŒ ÙˆÛÛŒ Ú©ÛŒ Ú†Ø§ÛÛŒÛ’
      SECRET_KEY_BASE: "5f8d93b2a1c4e6f7g8h9i0j1k2l3m4n4n5o6p7q8r9s0t1u2v3w4x5y6z7a8b9c0d1e2f3g4h5i6j7k8l9m0n1o2p3q4r5s6t7u8v9w0x1y2z"
      FRONTEND_URL: "http://localhost:3000"
    volumes:
      - chatwoot_storage:/app/storage
    command: bundle exec sidekiq -C config/sidekiq.yml

# ÙˆØ§Ù„ÛŒÙ…Ø² (ÚˆÛŒÙ¹Ø§ Ù…Ø­ÙÙˆØ¸ Ø±Ú©Ú¾Ù†Û’ Ú©Û’ Ù„ÛŒÛ’)
volumes:
  postgres_data:
  redis_data:
  chatwoot_storage:
