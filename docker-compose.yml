version: '3.8'

services:
  # 1. ÚˆÛŒÙ¹Ø§ Ø¨ÛŒØ³ (Postgres)
  postgres:
    image: postgres:15
    restart: always
    environment:
      POSTGRES_DB: chatwoot
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password123
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5

  # 2. Ù…ÛŒÙ…ÙˆØ±ÛŒ/Ú©ÛŒØ´ (Redis)
  redis:
    image: redis:alpine
    restart: always
    command: ["sh", "-c", "redis-server --requirepass $REDIS_PASSWORD"]
    environment:
      REDIS_PASSWORD: password123
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "password123", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5

  # 3. Ù…ÛŒÙ† ÙˆÛŒØ¨ Ø³Ø±ÙˆØ± (ÛŒÛØ§Úº Ø¢Ù¹ÙˆÙ…ÛŒØ´Ù† Ù„Ú¯ÛŒ ÛÛ’)
  web:
    image: chatwoot/chatwoot:latest
    restart: always
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    ports:
      - "3000:3000"
    environment:
      NODE_ENV: production
      RAILS_ENV: production
      INSTALLATION_ENV: docker
      DATABASE_URL: postgres://postgres:password123@postgres:5432/chatwoot
      REDIS_URL: redis://:password123@redis:6379
      ACTIVE_STORAGE_SERVICE: local
      RAILS_LOG_TO_STDOUT: true
      SECRET_KEY_BASE: change_this_to_something_very_long_and_random
      FRONTEND_URL: "http://localhost:3000" # Ø¬Ø¨ Ø±ÛŒÙ„ÙˆÛ’ ÚˆÙˆÙ…ÛŒÙ† Ø¯Û’ ØªÙˆ ÛŒÛØ§Úº Ø§Ù¾ÚˆÛŒÙ¹ Ú©Ø±ÛŒÚº
    volumes:
      - chatwoot_storage:/app/storage
    # ğŸ‘‡ Ø³Ø¨ Ø³Û’ Ø§ÛÙ… Ø­ØµÛ: ÛŒÛ Ú©Ù…Ø§Ù†Úˆ Ø®ÙˆØ¯ Ø³Ø¨ Ú©Ú†Ú¾ Ú©Ø±Û’ Ú¯ÛŒ ğŸ‘‡
    # ÛŒÛ Ú©ÛØªØ§ ÛÛ’: "Ù¾ÛÙ„Û’ DB ØªÛŒØ§Ø± Ú©Ø±ÙˆØŒ Ø§Ú¯Ø± Ø§ÛŒØ±Ø± Ø¢Ø¦Û’ (Ù…Ø·Ù„Ø¨ Ù¾ÛÙ„Û’ Ø³Û’ Ø¨Ù†Ø§ ÛÛ’) ØªÙˆ Ø§Ø³Û’ Ø§Ú¯Ù†ÙˆØ± Ú©Ø±Ùˆ Ø§ÙˆØ± Ø³Ø±ÙˆØ± Ø³Ù¹Ø§Ø±Ù¹ Ú©Ø± Ø¯Ùˆ"
    command: >
      sh -c "bundle exec rails db:chatwoot_prepare; 
             bundle exec rails s -p 3000 -b 0.0.0.0"

  # 4. Ø¨ÛŒÚ© Ú¯Ø±Ø§Ø¤Ù†Úˆ ÙˆØ±Ú©Ø±
  worker:
    image: chatwoot/chatwoot:latest
    restart: always
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      NODE_ENV: production
      RAILS_ENV: production
      INSTALLATION_ENV: docker
      DATABASE_URL: postgres://postgres:password123@postgres:5432/chatwoot
      REDIS_URL: redis://:password123@redis:6379
      ACTIVE_STORAGE_SERVICE: local
      SECRET_KEY_BASE: change_this_to_something_very_long_and_random
      FRONTEND_URL: "http://localhost:3000"
    volumes:
      - chatwoot_storage:/app/storage
    command: bundle exec sidekiq -C config/sidekiq.yml

# ÙˆØ§Ù„ÛŒÙ…Ø² Ú©ÛŒ ØªØ¹Ø±ÛŒÙ (ÚˆÛŒÙ¹Ø§ Ù…Ø­ÙÙˆØ¸ Ø±Ú©Ú¾Ù†Û’ Ú©Û’ Ù„ÛŒÛ’)
volumes:
  postgres_data:
  redis_data:
  chatwoot_storage:
